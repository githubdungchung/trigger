name: Clear Repository

on:
  workflow_dispatch:

jobs:
  clear-repo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }}
          persist-credentials: false

      - name: Remove all files except .github/workflows and .git directory
        run: |
          # Find all items in the repository excluding .git and .github/workflows
          items_to_delete=$(find . -mindepth 1 -not -path "./.git" -not -path "./.github" -not -path "./.github/workflows/*")

          # Remove each item if it exists
          for item in $items_to_delete; do
            if [ -e "$item" ]; then
              rm -rf "$item"
            fi
          done

          # If there are any changes, commit and push them
          if [ -n "$(git status --porcelain)" ]; then
            git config --global user.name 'githubdungchung'
            git config --global user.email '165872053+githubdungchung@users.noreply.github.com'
            git add .
            git commit -m "Clear repository except .github/workflows"
            git push -f https://githubdungchung:${{ secrets.PAT }}@github.com/${{ github.repository }}.git HEAD:main
