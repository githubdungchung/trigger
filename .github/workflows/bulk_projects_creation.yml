name: Bulk Projects Creation

on:
  workflow_dispatch:

jobs:
  install-packages:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }}

      - name: Set up Node.js
        uses: actions/setup-node@v4

      - name: Configure Git
        run: |
          git config --global user.name 'githubdungchung'
          git config --global user.email '165872053+githubdungchung@users.noreply.github.com'


      - name: Check number of files and trigger cleanup if necessary
        id: check_files
        run: |
          file_count=$(ls -1A | wc -l)
          echo "Number of files: $file_count"
          echo "::set-output name=file_count::$file_count"

      - name: Clear repository if file count exceeds 995
        if: steps.check_files.outputs.file_count > 995
        run: |
          # Create a temporary directory to store recent files
          mkdir temp
      
          # Move the latest 990 files to the temp directory
          ls -tp | grep -v '/$' | head -n 990 | xargs -I {} mv {} temp
      
          # Remove all files except .git, .github and README.md directories
          shopt -s extglob
          rm -rf !( .git| .github|temp|README.md)
      
          # Check if temp directory is not empty before moving files back
          if [ "$(ls -A temp)" ]; then
            mv temp/* .
          fi
      
          rmdir temp
      
          # Add changes to git
          git add .
          git commit -m "Retained the latest 990 files and removed older files"
          git push origin main
      
      - name: Generate random number of projects to create
        id: generate_random
        run: |
          random_number=$(shuf -i 1-30 -n 1)
          echo "Random number of projects to create: $random_number"
          echo "::set-output name=random_number::$random_number"

      - name: Create multiple projects
        run: |
          for i in $(seq 1 ${{ steps.generate_random.outputs.random_number }}); do
            TIMESTAMP=$(date +'%Y%m%d%H%M%S%N')
            PROJECT_DIR="$TIMESTAMP"
            
            # Create Next.js project with the specified options
            npx create-next-app@latest $PROJECT_DIR --ts --eslint --tailwind --no-src-dir --app --no-import-alias --use-npm
            
            cd $PROJECT_DIR
            npm install react-theme-switch-animation
            
            # Modify file to ensure changes
            echo "// Added by GitHub Actions" >> README.md
            # Commit and push changes
            git config --global user.name 'githubdungchung'
            git config --global user.email '165872053+githubdungchung@users.noreply.github.com'
            git add .
            git commit -m "Initialize Next.js project and install react-theme-switch-animation for $PROJECT_DIR"
            git push -f https://githubdungchung:${{ secrets.PAT }}@github.com/githubdungchung/trigger.git HEAD:main
            cd ..
            sleep 1  # Ensure the next timestamp is unique
          done

      - name: Update README with Project Creation Count
        run: |
          today=$(date +%Y-%m-%d)
          projects_created=${{ steps.generate_random.outputs.random_number }}
          if grep -q "| $today |" README.md; then
            # Update existing line
            sed -i "/| $today |/{s/|[^|]*|$/| $(($projects_created + $(awk -F'|' '/| '$today' |/{print $3}' README.md))) |/}" README.md
          else
            # Check if the header exists and add if it does not
            grep -q "| Date       | Number of Projects Created |" README.md || sed -i "/<!--START_SECTION:bulk_projects_creation-->/a | Date       | Number of Projects Created |\n|------------|----------------------------|" README.md
            # Add new date and project count
            sed -i "/|------------|----------------------------|/a | $today | $projects_created |" README.md
          fi
          git add README.md
          git commit -m "Updated README with project creation count for $today"
          git push https://${{ secrets.PAT }}@github.com/${{ github.repository }}.git HEAD:main

  trigger-next-job:
    needs: install-packages
    runs-on: ubuntu-latest
    steps:
    - name: Trigger Bulk Projects Creation workflow
      run: |
        curl -X POST \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: token ${{ secrets.PAT }}" \
          https://api.github.com/repos/${{ github.repository }}/actions/workflows/batch_creation_of_commits.yml/dispatches \
          -d '{"ref":"main"}'
